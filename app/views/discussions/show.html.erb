<% 
	add_body_class "discussion", "category#{@discussion.category_id}", "discussion_by_user#{@discussion.poster_id}"
	@page_title = @discussion.title
	previous_post = nil
-%>

<a name="top" class="anchor"></a>

<% if @discussion.editable_by?(@current_user) -%>
	<div class="functions">
		<%= link_to "Edit", edit_discussion_path(@discussion), :class => :edit %>
	</div>
<% end -%>

<h2 class="section">
	<%= link_to @discussion.category.name, category_path(@discussion.category) %> &raquo;
	<% if @discussion.labels? %>[<%= @discussion.labels.join(",") %>]<% end %>
	<%= link_to @discussion.title, discussion_path(@discussion) %>
</h2>

<%= render :partial => 'components/pagination', :locals => { :p => @posts } %>

<div class="posts">
	<% @posts.each do |post| %>
	<% if previous_post && (post.created_at - previous_post.created_at) >= 12.hours %>
		<div class="post_distance">
			<%= distance_of_time_in_words(post.created_at, previous_post.created_at) %> later&hellip;
		</div>
	<% end %>
	<div class="post post_by_user<%= post.user.id %>" id="post-<%= post.id %>">
		<div class="post_functions">
			<% if post.editable_by?(@current_user) %>
				<%= link_to "Edit", edit_discussion_post_path(@discussion, post) %> |
			<% end %>
			<%= link_to_remote "Quote", 
					:url => quote_discussion_post_url(@discussion, post),
					:complete => "addToReply(request.responseText)"
			%>
		</div>
		<div class="post_info">
			<a name="post-<%= post.id %>" class="anchor"></a>
			<span class="avatar">
				<%= avatar_image_tag(post.user) %>
			</span>
			<span class="username"><%= profile_link(post.user) %></span>
			<span class="date"><%= formatted_time post.created_at %></span>
			<span class="permalink">
				<%= link_to "#", paged_discussion_path(:id => @discussion, :page => @posts.page, :anchor => "post-#{post.id}"), :title => "Permalink to this post" %>
			</span>
		</div>
		<div class="body">
			<%= post.user.html_disabled? ? h(post.body).gsub(/\n/,'<br />') : post.body_html %>
			<% if post.edited? %><div class="edited">
				Edited <%= formatted_time post.edited_at %>
			</div><% end %>
		</div>
	</div>
	<% previous_post = post -%>
	<% end %>
</div>

<%= render :partial => 'components/pagination', :locals => { :p => @posts } %>

<a name="bottom"></a>
<div class="bottomlinks">
	<%= link_to "Back to discussions", discussions_path %>,
	<%= link_to "Top of page", "#top" %>
</div>

<% if @discussion.postable_by?(@current_user) %>

	<div id="compose-toggle"><%= link_to_function('Reply', 'showCompose();') %></div>

	<div class="compose" id="compose">

		<ul id="reply-tabs" class="tabs">  
			<li class="tab"><a href="#replyText">Write</a></li>  
			<li class="tab"><a href="#replyImage">Draw</a></li>  
		</ul>
		
		<% if @posts.last_page? && @posts.length == Post::POSTS_PER_PAGE %>
			<div class="newpage_warning">
				<strong>Warning:</strong> You're about to get newpage'd.
			</div>
		<% end %>
		
		<div id="replyText">
			<% form_for(@discussion.posts.new, :url => discussion_posts_path(@discussion)) do |f| %>
				<p><%= f.text_area(:body, :rows => 10, :cols => 80, :id => 'compose-body') %></p>
				<p><button type="submit">Post</button></p>
			<% end %>
		</div>
		<div id="replyImage">
			<script type="text/javascript">
				swfobject.registerObject("napkin", "9.0.31");
			
				function uploadDrawing() {
					$('napkin-submit').innerHTML = "Posting, please wait&hellip;";
					swfobject.getObjectById("napkin").uploadDrawing();
				}
			
				function onDrawingUploaded(url) {
					window.location.reload();
				}
			</script>

			<div class="napkin">
			<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" width="100%" height="300" id="napkin">
				<% napkin_vars = "service=" + doodle_discussion_posts_path(@discussion) -%>
				<param name="movie" value="/flash/napkin.swf" />
				<param name="flashvars" value="<%= napkin_vars %>" />
				<param name="allowScriptAccess" value="always" />
				<!--[if !IE]>-->
				<object type="application/x-shockwave-flash" data="/flash/napkin.swf?<%= napkin_vars %>" width="100%" height="400">
				<!--<![endif]-->
					<a href="http://www.adobe.com/go/getflashplayer">
						<img src="http://www.adobe.com/images/shared/download_buttons/get_flash_player.gif" alt="Get Adobe Flash player" />
					</a>
				<!--[if !IE]>-->
				</object>
				<!--<![endif]-->
			</object>
			</div>
			<p id="napkin-submit"><input name="commit" type="submit" value="Post" onClick="uploadDrawing()" /></p>
		</div>
	</div>
<% end %>

<script type="text/javascript">

	Element.hide('compose');
	
	new Control.Tabs('reply-tabs');  

	function showCompose()Â {
		Element.hide('compose-toggle');
		Element.show('compose');
	}

	function addToReply(string) {
		if( $('compose-body') ) {
			showCompose();
			$('compose-body').value += string;
		}
	}

	<% if @posts.last_page? -%>
		showCompose();
	<% end -%>
	
</script>