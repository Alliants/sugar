<% 
	add_body_class "discussion", "category#{@discussion.category_id}", "discussion_by_user#{@discussion.poster_id}"
	@page_title = h(@discussion.title)
	previous_post = nil
-%>

<a name="top" class="anchor"></a>

<% if @discussion.editable_by?(@current_user) -%>
	<div class="functions">
		<%= link_to "Edit", edit_discussion_path(@discussion), :class => :edit %>
	</div>
<% end -%>

<h2 class="section">
	<%= link_to @discussion.category.name, category_path(@discussion.category) %> &raquo;
	<% if @discussion.labels? %>[<%= @discussion.labels.join(",") %>]<% end %>
	<%= link_to h(@discussion.title), discussion_path(@discussion) %>
</h2>

<%= render :partial => 'posts/posts', :locals => {:posts => @posts, :discussion => @discussion, :functions => true, :permalink => true, :post_distance => true} %>

<a name="bottom"></a>
<div class="bottomlinks">
	<%= link_to "Back to discussions", discussions_path %>,
	<%= link_to "Top of page", "#top" %>
</div>

<% if @discussion.postable_by?(@current_user) %>

	<div id="compose-toggle"><%= link_to_function('Reply', 'showCompose();') %></div>

	<div class="compose" id="compose">

		<ul id="reply-tabs" class="tabs">  
			<li class="tab" id="write-tab"><a href="#replyText">Write</a></li>  
			<li class="tab" id="draw-tab"><a href="#replyImage">Draw</a></li>  
		</ul>
		
		<% if @posts.last_page? && @posts.length == Post::POSTS_PER_PAGE %>
			<div class="newpage_warning">
				<strong>Warning:</strong> You're about to get newpage'd.
			</div>
		<% end %>
		
		<div id="replyText">
			<% form_for(@discussion.posts.new, :url => discussion_posts_path(@discussion), :html => { :onsubmit => "$('button-container').innerHTML='Posting...';" }) do |f| %>
				<p><%= f.text_area(:body, :rows => 10, :cols => 80, :id => 'compose-body') %></p>
				<p id="button-container"><button type="submit">Post</button></p>
			<% end %>
		</div>
		<div id="replyImage">
			<script type="text/javascript">
				swfobject.registerObject("napkin", "9.0.31");
			
				function uploadDrawing() {
					$('napkin-submit').innerHTML = "Posting, please wait&hellip;";
					swfobject.getObjectById("napkin").uploadDrawing();
				}
			
				function onDrawingUploaded(url) {
					window.location.reload();
				}
			</script>

			<div class="napkin">
			<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" width="100%" height="400" id="napkin">
				<% napkin_vars = "service=" + doodle_discussion_posts_path(@discussion) -%>
				<param name="movie" value="/flash/napkin.swf" />
				<param name="flashvars" value="<%= napkin_vars %>" />
				<param name="allowScriptAccess" value="always" />
				<!--[if !IE]>-->
				<object type="application/x-shockwave-flash" data="/flash/napkin.swf?<%= napkin_vars %>" width="100%" height="400">
				<!--<![endif]-->
					<a href="http://www.adobe.com/go/getflashplayer">
						<img src="http://www.adobe.com/images/shared/download_buttons/get_flash_player.gif" alt="Get Adobe Flash player" />
					</a>
				<!--[if !IE]>-->
				</object>
				<!--<![endif]-->
			</object>
			</div>
			<p id="napkin-submit"><input name="commit" type="submit" value="Post" onClick="uploadDrawing()" /></p>
		</div>
	</div>
<% end %>

<script type="text/javascript">

	Element.hide('compose');
	
	new Control.Tabs('reply-tabs');

	function showCompose() {
		Element.hide('compose-toggle');
		Element.show('compose');
	}

	function addToReply(string) {
		if( $('compose-body') ) {
			showCompose();
			$('compose-body').value += string;
		}
	}

	// Make previous napkins clickable
	$$('.drawing img').each(function(image) {
		Event.observe(image, 'click', function(evnt) {
			if(swfobject.getObjectById("napkin")) {
				swfobject.getObjectById("napkin").setBackground(Event.element(evnt).src);
			}
		});
	});

	<% if @posts.last_page? -%>
		showCompose();
	<% end -%>
	
</script>